<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', path='favicon.ico') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTRA Risk Analytics Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/dashboard.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è ASTRA Risk Analytics Dashboard</h1>
            <p class="subtitle">Adaptive Surveillance Tracking and Recognition Architecture</p>
            {% if available_detectors %}
            <div class="detector-selector">
                <form method="post" action="/dashboard/set-detector">
                    <label for="detector_name">Detector:</label>
                    <select id="detector_name" name="detector_name">
                        {% for d in available_detectors %}
                        <option value="{{ d }}" {% if d == active_detector %}selected{% endif %}>{{ d }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Switch</button>
                </form>
                <p class="detector-status">Current detector: {{ active_detector or 'unknown' }}</p>
            </div>
            {% endif %}
        </header>

        {% if error %}
        <p class="error-message">{{ error }}</p>
        {% endif %}

        <div class="input-grid">
            <div class="stat-card">
                <h2>Analyze Typed Text</h2>
                <form method="post" action="/dashboard/analyze-text">
                    <textarea name="text" rows="5" placeholder="Paste or type text to analyze..." required></textarea>
                    <div class="form-actions">
                        <button type="submit">Analyze Text</button>
                    </div>
                </form>
            </div>
            <div class="stat-card">
                <h2>Analyze Uploaded File</h2>
                <form method="post" action="/dashboard/upload-file" enctype="multipart/form-data">
                    <label for="file-upload">Select file to analyze:</label>
                    <input type="file" id="file-upload" name="file" accept=".txt,.md,.log,.json,.csv" required>
                    <div class="form-actions">
                        <button type="submit">Upload &amp; Analyze</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Events</h3>
                <div class="stat-value">{{ stats.total_events }}</div>
            </div>
            <div class="stat-card">
                <h3>Average Confidence</h3>
                <div class="stat-value">{{ "%.2f"|format(stats.avg_confidence * 100) }}%</div>
            </div>
        </div>

        {% if stats.by_label %}
        <div class="label-breakdown">
            <h2>Detection Breakdown</h2>
            {% for label, count in stats.by_label.items() %}
            <div class="label-bar">
                <div class="label-name">
                    <span>{{ label }}</span>
                    <span>{{ count }} events</span>
                </div>
                <div class="bar" data-percent="{{ (count / stats.total_events * 100) }}"></div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="label-breakdown" id="cooccurrence-panel">
            <h2>Co-occurrence Graph (actor_id ‚Üî source_hash)</h2>
            <p class="subtitle" id="cooccurrence-status">Loading graph‚Ä¶</p>
            <div class="graph-container">
                <svg id="cooccurrence-graph" role="img" aria-label="Actor/source_hash co-occurrence graph"></svg>
            </div>
        </div>

        <div class="records-table">
            <h2>Recent Detections (Last 50)</h2>
            {% if records %}
            <table>
                <thead>
                    <tr>
                        <th>Event ID</th>
                        <th>Source</th>
                        <th>Text Preview</th>
                        <th>Detection</th>
                        <th>Confidence</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td>{{ record.event_id[:8] }}...</td>
                        <td>{{ record.source }}</td>
                        <td class="text-preview">
                            {{ record.text_preview }}
                        </td>
                        <td>
                            {% if "AI" in record.detection_label %}
                                <span class="badge badge-ai">{{ record.detection_label }}</span>
                            {% elif "human" in record.detection_label %}
                                <span class="badge badge-human">{{ record.detection_label }}</span>
                            {% else %}
                                <span class="badge badge-suspicious">{{ record.detection_label }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.confidence > 0.7 %}
                                <span class="confidence high-confidence">{{ "%.1f"|format(record.confidence * 100) }}%</span>
                            {% elif record.confidence > 0.4 %}
                                <span class="confidence medium-confidence">{{ "%.1f"|format(record.confidence * 100) }}%</span>
                            {% else %}
                                <span class="confidence low-confidence">{{ "%.1f"|format(record.confidence * 100) }}%</span>
                            {% endif %}
                        </td>
                        <td>{{ record.timestamp.strftime('%Y-%m-%d %H:%M:%S') if record.timestamp else 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="empty-state">No detection records yet. Start by ingesting content and running detection.</p>
            {% endif %}
        </div>
    </div>

    <script>
        (function () {
            function svgEl(tag) {
                return document.createElementNS('http://www.w3.org/2000/svg', tag);
            }

            function buildAdjacency(edges) {
                var adj = new Map();
                for (var i = 0; i < edges.length; i++) {
                    var e = edges[i];
                    if (!adj.has(e.source)) adj.set(e.source, []);
                    if (!adj.has(e.target)) adj.set(e.target, []);
                    adj.get(e.source).push(e.target);
                    adj.get(e.target).push(e.source);
                }
                return adj;
            }

            function connectedComponents(nodeIds, adjacency) {
                var seen = new Set();
                var comps = [];

                for (var i = 0; i < nodeIds.length; i++) {
                    var start = nodeIds[i];
                    if (seen.has(start)) continue;
                    var stack = [start];
                    var comp = [];
                    seen.add(start);
                    while (stack.length) {
                        var cur = stack.pop();
                        comp.push(cur);
                        var nbrs = adjacency.get(cur) || [];
                        for (var j = 0; j < nbrs.length; j++) {
                            var n = nbrs[j];
                            if (!seen.has(n)) {
                                seen.add(n);
                                stack.push(n);
                            }
                        }
                    }
                    comps.push(comp);
                }
                comps.sort(function (a, b) { return b.length - a.length; });
                return comps;
            }

            function clearSvg(svg) {
                while (svg.firstChild) svg.removeChild(svg.firstChild);
            }

            function renderGraph(svg, data) {
                clearSvg(svg);

                var nodes = data.nodes || [];
                var edges = data.edges || [];
                if (!nodes.length || !edges.length) {
                    return { rendered: false };
                }

                var width = svg.clientWidth || 1200;
                var height = 420;
                svg.setAttribute('viewBox', '0 0 ' + width + ' ' + height);

                var nodeById = new Map();
                for (var i = 0; i < nodes.length; i++) {
                    nodeById.set(nodes[i].id, nodes[i]);
                }

                var adjacency = buildAdjacency(edges);
                var nodeIds = nodes.map(function (n) { return n.id; });
                var comps = connectedComponents(nodeIds, adjacency);

                // Layout: each connected component becomes a "cluster" block.
                // Actors on left, hashes on right.
                var paddingX = 24;
                var paddingY = 18;
                var leftX = paddingX + 16;
                var rightX = width - paddingX - 16;
                var y = 24;

                var positions = new Map();

                for (var c = 0; c < comps.length; c++) {
                    var compIds = comps[c];

                    // Split by type.
                    var actors = [];
                    var hashes = [];
                    for (var k = 0; k < compIds.length; k++) {
                        var n = nodeById.get(compIds[k]);
                        if (!n) continue;
                        if (n.type === 'actor') actors.push(n);
                        else hashes.push(n);
                    }

                    if (!actors.length && !hashes.length) continue;

                    var rows = Math.max(actors.length, hashes.length);
                    var available = Math.max(60, height - y - 24);
                    var rowGap = Math.max(14, Math.min(26, Math.floor(available / Math.max(1, rows))));
                    var compHeight = Math.max(48, rows * rowGap + paddingY);

                    for (var a = 0; a < actors.length; a++) {
                        positions.set(actors[a].id, { x: leftX, y: y + paddingY + a * rowGap });
                    }
                    for (var h = 0; h < hashes.length; h++) {
                        positions.set(hashes[h].id, { x: rightX, y: y + paddingY + h * rowGap });
                    }

                    // Cluster outline (subtle).
                    var box = svgEl('rect');
                    box.setAttribute('x', paddingX);
                    box.setAttribute('y', y);
                    box.setAttribute('width', width - paddingX * 2);
                    box.setAttribute('height', Math.min(compHeight, height - y - 8));
                    box.setAttribute('rx', '8');
                    box.setAttribute('class', 'graph-cluster');
                    svg.appendChild(box);

                    y += compHeight + 12;
                    if (y > height - 36) break;
                }

                // Draw edges first.
                var maxW = 1;
                for (var ei = 0; ei < edges.length; ei++) {
                    if (edges[ei].weight > maxW) maxW = edges[ei].weight;
                }
                for (var e = 0; e < edges.length; e++) {
                    var edge = edges[e];
                    var p1 = positions.get(edge.source);
                    var p2 = positions.get(edge.target);
                    if (!p1 || !p2) continue;
                    var line = svgEl('line');
                    line.setAttribute('x1', p1.x);
                    line.setAttribute('y1', p1.y);
                    line.setAttribute('x2', p2.x);
                    line.setAttribute('y2', p2.y);
                    line.setAttribute('class', 'graph-edge');
                    var w = 1 + Math.round(3 * (edge.weight / maxW));
                    line.setAttribute('stroke-width', String(w));
                    svg.appendChild(line);
                }

                // Then nodes.
                for (var ni = 0; ni < nodes.length; ni++) {
                    var node = nodes[ni];
                    var pos = positions.get(node.id);
                    if (!pos) continue;

                    var g = svgEl('g');

                    var circle = svgEl('circle');
                    circle.setAttribute('cx', pos.x);
                    circle.setAttribute('cy', pos.y);
                    circle.setAttribute('r', '7');
                    circle.setAttribute('class', node.type === 'actor' ? 'graph-node graph-node-actor' : 'graph-node graph-node-hash');
                    g.appendChild(circle);

                    var text = svgEl('text');
                    text.setAttribute('x', node.type === 'actor' ? (pos.x + 12) : (pos.x - 12));
                    text.setAttribute('y', pos.y + 4);
                    text.setAttribute('text-anchor', node.type === 'actor' ? 'start' : 'end');
                    text.setAttribute('class', 'graph-label');
                    text.textContent = node.label;
                    g.appendChild(text);

                    svg.appendChild(g);
                }

                return { rendered: true };
            }

            var statusEl = document.getElementById('cooccurrence-status');
            var svg = document.getElementById('cooccurrence-graph');
            if (!statusEl || !svg) return;

            fetch('/graph/cooccurrence', { headers: { 'Accept': 'application/json' } })
                .then(function (r) {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(function (data) {
                    var result = renderGraph(svg, data);
                    if (!result.rendered) {
                        statusEl.textContent = 'No graph data yet (need events with actor_id + source_hash).';
                    } else {
                        statusEl.textContent = 'Clusters are connected components from co-occurrence counts.';
                    }
                })
                .catch(function (err) {
                    statusEl.textContent = 'Failed to load graph: ' + err.message;
                });
        })();
    </script>
</body>
</html>
