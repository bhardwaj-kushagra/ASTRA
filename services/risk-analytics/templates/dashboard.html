<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', path='favicon.ico') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTRA Risk Analytics Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/dashboard.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è ASTRA Risk Analytics Dashboard</h1>
            <p class="subtitle">Adaptive Surveillance Tracking and Recognition Architecture</p>
        </header>

        {% if error %}
        <p class="error-message">{{ error }}</p>
        {% endif %}

        <div class="input-grid">
            <div class="stat-card">
                <h2>Analyze Typed Text</h2>
                <form method="post" action="/dashboard/analyze-text">
                    <textarea name="text" rows="5" placeholder="Paste or type text to analyze..." required></textarea>
                    <div class="form-actions">
                        <button type="submit">Analyze Text</button>
                    </div>
                </form>
            </div>
            <div class="stat-card">
                <h2>Analyze Uploaded File</h2>
                <form method="post" action="/dashboard/upload-file" enctype="multipart/form-data">
                    <input type="file" name="file" accept=".txt,.md,.log,.json,.csv" required>
                    <div class="form-actions">
                        <button type="submit">Upload &amp; Analyze</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Events</h3>
                <div class="stat-value">{{ stats.total_events }}</div>
            </div>
            <div class="stat-card">
                <h3>Average Confidence</h3>
                <div class="stat-value">{{ "%.2f"|format(stats.avg_confidence * 100) }}%</div>
            </div>
        </div>

        {% if stats.by_label %}
        <div class="label-breakdown">
            <h2>Detection Breakdown</h2>
            {% for label, count in stats.by_label.items() %}
            <div class="label-bar">
                <div class="label-name">
                    <span>{{ label }}</span>
                    <span>{{ count }} events</span>
                </div>
                <div class="bar" data-percent="{{ (count / stats.total_events * 100) }}"></div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="records-table">
            <h2>Recent Detections (Last 50)</h2>
            {% if records %}
            <table>
                <thead>
                    <tr>
                        <th>Event ID</th>
                        <th>Source</th>
                        <th>Text Preview</th>
                        <th>Detection</th>
                        <th>Confidence</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td>{{ record.event_id[:8] }}...</td>
                        <td>{{ record.source }}</td>
                        <td class="text-preview">
                            {{ record.text_preview }}
                        </td>
                        <td>
                            {% if "AI" in record.detection_label %}
                                <span class="badge badge-ai">{{ record.detection_label }}</span>
                            {% elif "human" in record.detection_label %}
                                <span class="badge badge-human">{{ record.detection_label }}</span>
                            {% else %}
                                <span class="badge badge-suspicious">{{ record.detection_label }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.confidence > 0.7 %}
                                <span class="confidence high-confidence">{{ "%.1f"|format(record.confidence * 100) }}%</span>
                            {% elif record.confidence > 0.4 %}
                                <span class="confidence medium-confidence">{{ "%.1f"|format(record.confidence * 100) }}%</span>
                            {% else %}
                                <span class="confidence low-confidence">{{ "%.1f"|format(record.confidence * 100) }}%</span>
                            {% endif %}
                        </td>
                        <td>{{ record.timestamp.strftime('%Y-%m-%d %H:%M:%S') if record.timestamp else 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="empty-state">No detection records yet. Start by ingesting content and running detection.</p>
            {% endif %}
        </div>
    </div>
</body>
</html>
